http://hamedj.ir/blog/ROS-Bag-D435/

recording point clouds using rtabmap+realsense d435

1) Use RTABMAP online: http://wiki.ros.org/rtabmap_ros/Tutorials/HandHeldMapping
	(a) terminal 1
		$ roslaunch realsense2_camera rs_camera.launch align_depth:=true	
	(b) terminal 2
		$ roslaunch rtabmap_ros rtabmap.launch \
    rtabmap_args:="--delete_db_on_start" \
    depth_topic:=/camera/aligned_depth_to_color/image_raw \
    rgb_topic:=/camera/color/image_raw \
    camera_info_topic:=/camera/color/camera_info \
    approx_sync:=false

2) can't record rosbag in the regular way as it makes the realsense node error:
	(a) terminal 1
		$ roslaunch realsense2_camera rs_camera.launch align_depth:=true
	(b) terminal 2
		$ rosbag record -a

	---> in terminal (a):
		[ERROR] [1643888779.062679576]: cv_bridge exception: '[16UC1] is not a color format. but [bgr8] is. The conversion does not make sense'

	internet search:
		https://github.com/IntelRealSense/realsense-ros/issues/1076
		--> there are problems recording 'compressed depth'

	I downloaded a rosbag demo from http://wiki.ros.org/rtabmap_ros#Demos:
		https://docs.google.com/uc?id=0B46akLGdg-uadXhLeURiMTBQU28&export=download
	to run the example:
		$ roslaunch rtabmap_ros demo_robot_mapping.launch
		$ rosbag play --clock demo_mapping.bag

	to see what topics run from the bag file:
		$ rosbag info demo_mapping.bag
		$ robag info 
		------------> topics:
			/az3/base_controller/odom
			/jn0/base_scan 
			/tf
			/data_throttled_camera_info   	
			data_throttled_image/compressed
			data_throttled_image_depth/compressedDepth

	I then ran just the realsense2_camera launch file to understand what topics it has running
		$ roslaunch realsense2_camera rs_camera.launch align_depth:=true
		$ rostopic list
		------------> topics:
			/camera/align_to_color/parameter_descriptions
			/camera/align_to_color/parameter_updates
			/camera/aligned_depth_to_color/camera_info
			/camera/aligned_depth_to_color/image_raw
			/camera/aligned_depth_to_color/image_raw/compressed
			/camera/aligned_depth_to_color/image_raw/compressed/parameter_descriptions
			/camera/aligned_depth_to_color/image_raw/compressed/parameter_updates
			/camera/aligned_depth_to_color/image_raw/compressedDepth
			/camera/aligned_depth_to_color/image_raw/compressedDepth/parameter_descriptions
			/camera/aligned_depth_to_color/image_raw/compressedDepth/parameter_updates
			/camera/aligned_depth_to_color/image_raw/theora
			/camera/aligned_depth_to_color/image_raw/theora/parameter_descriptions
			/camera/aligned_depth_to_color/image_raw/theora/parameter_updates
			/camera/color/camera_info
			/camera/color/image_raw
			/camera/color/image_raw/compressed
			/camera/color/image_raw/compressed/parameter_descriptions
			/camera/color/image_raw/compressed/parameter_updates
			/camera/color/image_raw/compressedDepth
			/camera/color/image_raw/compressedDepth/parameter_descriptions
			/camera/color/image_raw/compressedDepth/parameter_updates
			/camera/color/image_raw/theora
			/camera/color/image_raw/theora/parameter_descriptions
			/camera/color/image_raw/theora/parameter_updates
			/camera/color/metadata
			/camera/depth/camera_info
			/camera/depth/image_rect_raw
			/camera/depth/image_rect_raw/compressed
			/camera/depth/image_rect_raw/compressed/parameter_descriptions
			/camera/depth/image_rect_raw/compressed/parameter_updates
			/camera/depth/image_rect_raw/compressedDepth
			/camera/depth/image_rect_raw/compressedDepth/parameter_descriptions
			/camera/depth/image_rect_raw/compressedDepth/parameter_updates
			/camera/depth/image_rect_raw/theora
			/camera/depth/image_rect_raw/theora/parameter_descriptions
			/camera/depth/image_rect_raw/theora/parameter_updates
			/camera/depth/metadata
			/camera/extrinsics/depth_to_color
			/camera/realsense2_camera_manager/bond
			/camera/rgb_camera/auto_exposure_roi/parameter_descriptions
			/camera/rgb_camera/auto_exposure_roi/parameter_updates
			/camera/rgb_camera/parameter_descriptions
			/camera/rgb_camera/parameter_updates
			/camera/stereo_module/auto_exposure_roi/parameter_descriptions
			/camera/stereo_module/auto_exposure_roi/parameter_updates
			/camera/stereo_module/parameter_descriptions
			/camera/stereo_module/parameter_updates
			/diagnostics
			/rosout
			/rosout_agg
			/tf
			/tf_static

	lets try to record only compresssedDepth as I know it is needed from the demo .bag file.
			$ roslaunch realsense2_camera rs_camera.launch align_depth:=true
			$ rosbag record data_throttled_ima/compressed
		
			---> seems to work

	Let's understand what topics I need for the rtab mapping:
			$ roslaunch rtabmap_ros rtabmap.launch \
    rtabmap_args:="--delete_db_on_start" \
    depth_topic:=/camera/aligned_depth_to_color/image_raw \
    rgb_topic:=/camera/color/image_raw \
    camera_info_topic:=/camera/color/camera_info \
    approx_sync:=false
			$ rostopic list -s #list only subscribers
		------------> topics:
			/camera/aligned_depth_to_color/image_raw
			/camera/color/camera_info
			/camera/color/image_raw
			/gps/fix
			/imu/data
			/rosout
			/rtabmap/global_path
			/rtabmap/global_pose
			/rtabmap/goal
			/rtabmap/goal_node
			/rtabmap/goal_reached
			/rtabmap/info
			/rtabmap/initialpose
			/rtabmap/mapData
			/rtabmap/odom
			/rtabmap/odom_info
			/rtabmap/republish_node_data
			/tag_detections
			/tf
			/tf_static
			/user_data_async

		------------> clearing rtabmap topics:
			/camera/aligned_depth_to_color/image_raw
			/camera/color/camera_info
			/camera/color/image_raw
			/gps/fix
			/imu/data
			/rosout
			/tag_detections
			/tf
			/tf_static
			/user_data_async

	
	Lets open the launch file to understand the topic remappings from what realsense2 publishes
			$ roscd rtabmap_ros
			$ cd launch
			$ code rtabmap.launch

			#when launching rtabmap.launch we note the topics. Hence, in the launch file:
			We won't find  "/camera/aligned_depth_to_color/image_raw"
			We will find "depth_topic"

	lets try to record a smaller bag file with less topics (name is temp.bag)
	$ roslaunch realsense2_camera rs_camera.launch align_depth:=true
	$ rosbag record -O temp.bag /camera/aligned_depth_to_color/image_raw /camera/color/camera_info /camera/color/image_raw /tf /tf_static
	#FINISH RECORDING
	
	#now run the following:
		$ roslaunch rtabmap_ros rtabmap.launch \
    rtabmap_args:="--delete_db_on_start" \
    depth_topic:=/camera/aligned_depth_to_color/image_raw \
    rgb_topic:=/camera/color/image_raw \
    camera_info_topic:=/camera/color/camera_info \
    approx_sync:=false
		$ rosbag play --clock temp.bag
		
		# This worked alright :)
	
	Now lets use rtabmap + realsense, and record just what we need in the bag file. Then play it and see if rtabmap builds the same map.
		# STEP (A)
		$ roslaunch realsense2_camera rs_camera.launch align_depth:=true
		$ roslaunch rtabmap_ros rtabmap.launch \
    rtabmap_args:="--delete_db_on_start" \
    depth_topic:=/camera/aligned_depth_to_color/image_raw \
    rgb_topic:=/camera/color/image_raw \
    camera_info_topic:=/camera/color/camera_info \
    approx_sync:=false
		$ rosbag record -O temp.bag /camera/aligned_depth_to_color/image_raw /camera/color/camera_info /camera/color/image_raw /tf /tf_static

		# STEP (B)
		$ roslaunch rtabmap_ros rtabmap.launch \
    rtabmap_args:="--delete_db_on_start" \
    depth_topic:=/camera/aligned_depth_to_color/image_raw \
    rgb_topic:=/camera/color/image_raw \
    camera_info_topic:=/camera/color/camera_info \
    approx_sync:=false
		$ rosbag play --clock temp.bag
	
	

			
	
	
	
			
